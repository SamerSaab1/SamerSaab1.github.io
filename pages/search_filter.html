<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="../assets/style.css">
  <title>Search Filter</title>
</head>
<!-- MEETING DETAILS MODAL -->
<div id="meetingModal" class="modal-backdrop" style="display:none;">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div id="mTitle" class="modal-title"></div>
        <div id="mSub" class="modal-sub"></div>
      </div>
      <button id="mClose" class="modal-close" aria-label="Close">✕</button>
    </div>

    <div class="modal-body">
      <div class="pill-row">
        <span id="mConfidence" class="pill"></span>
        <span id="mCategory" class="pill"></span>
        <span id="mRegion" class="pill"></span>
      </div>

      <h3>How this meeting aligns with the selection criteria</h3>

      <div class="criteria-box">
        <div class="crit">
          <div class="crit-h">1) Non-Proceedings criterion</div>
          <div class="crit-b"><span id="mRecord"></span></div>
        </div>

        <div class="crit">
          <div class="crit-h">2) Prestige / standing signal</div>
          <div class="crit-b" id="mEvidenceSummary"></div>
        </div>

        <div class="crit">
          <div class="crit-h">3) Evidence requirement</div>
          <div class="crit-b" id="mEvidenceLinks"></div>
        </div>

        <div class="crit">
          <div class="crit-h">4) Confidence classification</div>
          <div class="crit-b" id="mConfExplain"></div>
        </div>
      </div>

      <div class="modal-footnote">
        Note: This is a contextual reference list, not a ranking.
      </div>
    </div>
  </div>
</div>

<body>

<!-- GLOBAL ORBIT ANIMATION -->
<div class="orbit-global">
  <div class="center">ORBIT</div>
  <div class="ring r1"><div class="sat s1" title="Medicine & Health"></div></div>
  <div class="ring r2"><div class="sat s2" title="Biology & Life Sciences"></div></div>
  <div class="ring r3"><div class="sat s3" title="Business & Economics"></div></div>
  <div class="ring r4"><div class="sat s4" title="Social Sciences"></div></div>
  <div class="ring r5"><div class="sat s5" title="Humanities & Arts"></div></div>
  <div class="ring r6"><div class="sat s6" title="Physical & Mathematical Sciences"></div></div>
</div>

<header class="orbit-header">
  <h1>Search Filter</h1>
  <p>Filter meetings by category, subdiscipline, region, confidence, and record type.</p>

  <div class="navwrap">
    <a class="navtab" href="../index.html">Search</a>
    <a class="navtab active" href="search_filter.html">Search Filter</a>
    <a class="navtab" href="about.html">About</a>
    <a class="navtab" href="criteria.html">Selection Criteria</a>
    <a class="navtab" href="faq.html">FAQ</a>
    <a class="navtab" href="distribution.html">Distribution</a>
  </div>
</header>

<main>
  <div class="page-card">
    <div class="filters-grid">
      <select id="cat"><option value="">Category (All)</option></select>
      <select id="sub"><option value="">Subdiscipline (All)</option></select>
      <select id="reg"><option value="">Region (All)</option></select>
      <select id="conf"><option value="">Confidence (All)</option></select>
      <select id="rec"><option value="">Record Type (All)</option></select>
    </div>

    <p id="count2" class="meta-text">Loading…</p>
    <p class="meta-text"><strong>Tip:</strong> Click a row to see how the meeting aligns with the selection criteria (and confidence level). Use ↗ to open the official website.</p>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Category</th><th>Subdiscipline</th><th>Meeting</th><th>Acronym</th>
            <th>Society</th><th>Region</th><th>Record Type</th><th>Confidence</th>
          </tr>
        </thead>
        <tbody id="rows2"></tbody>
      </table>
    </div>
  </div>
</main>

<script>
const count2 = document.getElementById("count2");
const rows2  = document.getElementById("rows2");
const modal = document.getElementById("meetingModal");
const closeBtn = document.getElementById("mClose");

function getSociety(m){
  if (m && typeof m.Organizer === "object" && m.Organizer) return m.Organizer.Society || "";
  return m["Organizer/Society"] || "";
}

function escapeHtml(s){
  return (s ?? "").toString()
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

function openMeetingModal(m){
  if (!modal) return;

  document.getElementById("mTitle").textContent = `${m.Meeting || ""} (${m.Acronym || ""})`;
  document.getElementById("mSub").textContent = `${m.Subdiscipline || ""} • ${getSociety(m) || ""}`;

  const conf = (m.Confidence || "").toString();
  const confEl = document.getElementById("mConfidence");
  confEl.textContent = `Confidence: ${conf || "—"}`;
  confEl.className = "pill " + (conf.toLowerCase().startsWith("high") ? "high" : "medium");

  document.getElementById("mCategory").textContent = `Category: ${m.Category || "—"}`;
  document.getElementById("mRegion").textContent = `Region: ${m.Region || "—"}`;

  document.getElementById("mRecord").textContent = m.NonProceedingsRecordType || "—";
  document.getElementById("mEvidenceSummary").textContent = m.EvidenceSummary || "—";

  const ev  = (m.EvidenceURL || "").toString().trim();
  const off = (m.OfficialURL || "").toString().trim();
  document.getElementById("mEvidenceLinks").innerHTML =
    `${ev ? `<a href="${escapeHtml(ev)}" target="_blank" rel="noopener noreferrer">Evidence URL</a>` : "No evidence link provided."}
     ${ev && off ? " · " : ""}
     ${off ? `<a href="${escapeHtml(off)}" target="_blank" rel="noopener noreferrer">Official URL</a>` : ""}`;

  document.getElementById("mConfExplain").textContent =
    conf.toLowerCase().startsWith("high")
      ? "High confidence: the non-proceedings scholarly record is clearly documented and easy to verify."
      : "Medium confidence: the meeting is clearly prestigious, but public documentation is less explicit or varies by year.";

  modal.style.display = "flex";
}

function closeMeetingModal(){
  if (!modal) return;
  modal.style.display = "none";
}

if (closeBtn) closeBtn.onclick = closeMeetingModal;

if (modal){
  modal.addEventListener("click", (e) => {
    if (e.target === modal) closeMeetingModal();
  });
}

document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") closeMeetingModal();
});

function uniq(list){ return Array.from(new Set(list.filter(x=>x))).sort(); }

function fill(id, vals){
  const s = document.getElementById(id);
  vals.forEach(v => {
    const o = document.createElement("option");
    o.value = v;
    o.textContent = v;
    s.appendChild(o);
  });
}

function render(list){
  rows2.innerHTML = "";
  list.forEach(m=>{
    const meetingText = escapeHtml(m.Meeting || "");
    const url = (m.OfficialURL || "").toString().trim();
    const meetingCell = `
      <strong>${meetingText}</strong>
      ${url ? ` <a class="mini-link" href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer" title="Open official website">↗</a>` : "" }
    `;

    const tr = document.createElement("tr");
    tr.style.cursor = "pointer";
    tr.innerHTML = `
      <td>${escapeHtml(m.Category||"")}</td>
      <td>${escapeHtml(m.Subdiscipline||"")}</td>
      <td>${meetingCell}</td>
      <td>${escapeHtml(m.Acronym||"")}</td>
      <td>${escapeHtml(getSociety(m)||"")}</td>
      <td>${escapeHtml(m.Region||"")}</td>
      <td>${escapeHtml(m.NonProceedingsRecordType||"")}</td>
      <td>${escapeHtml(m.Confidence||"")}</td>
    `;

    tr.addEventListener("click", (evt) => {
      if (evt.target.closest("a")) return;
      openMeetingModal(m);
    });

    rows2.appendChild(tr);
  });

  count2.textContent = `${list.length} meetings shown`;
}

fetch("/data/meetings.json", { cache: "no-store" })
  .then(r => r.json())
  .then(data=>{
    fill("cat", uniq(data.map(x=>x.Category)));
    fill("sub", uniq(data.map(x=>x.Subdiscipline)));
    fill("reg", uniq(data.map(x=>x.Region)));
    fill("conf", uniq(data.map(x=>x.Confidence)));
    fill("rec", uniq(data.map(x=>x.NonProceedingsRecordType)));

    function apply(){
      const cat = document.getElementById("cat").value;
      const sub = document.getElementById("sub").value;
      const reg = document.getElementById("reg").value;
      const conf = document.getElementById("conf").value;
      const rec = document.getElementById("rec").value;

      let out = data.slice();
      if (cat) out = out.filter(x=>x.Category===cat);
      if (sub) out = out.filter(x=>x.Subdiscipline===sub);
      if (reg) out = out.filter(x=>x.Region===reg);
      if (conf) out = out.filter(x=>x.Confidence===conf);
      if (rec) out = out.filter(x=>x.NonProceedingsRecordType===rec);

      render(out);
    }

    ["cat","sub","reg","conf","rec"].forEach(id=>{
      document.getElementById(id).addEventListener("change", apply);
    });

    render(data);
  })
  .catch(err=>{
    console.error(err);
    count2.textContent = "Failed to load data.";
  });
</script>


</body>
</html>
